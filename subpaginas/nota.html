<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Nota</title>
</head>
<body>
    <header>
        <h1 id="nota-titulo">Nota</h1>
        <div id="nota-descripcion"></div>
    </header>
    
    <section id="nota-detalles">
        <p><strong>Publicado por:</strong> <span id="nota-publicado-por">Desconocido</span></p>
        <p><strong>Rol del autor:</strong> <span id="nota-rol">Desconocido</span></p>
        <p><strong>Fecha de publicación:</strong> <span id="nota-fecha-publicacion">Desconocida</span></p>
    </section>

    <section id="nota-contenido">
        <!-- Aquí se renderiza el contenido Markdown -->
    </section>

    <section id="nota-concepto">
        <!-- Aquí se mostrará el concepto -->
    </section>

    <section id="nota-imagen-container">
        <img id="nota-imagen" style="display:none;" alt="Imagen de la nota" />
    </section>

    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script>
        async function loadMarkdown() {
            const urlParams = new URLSearchParams(window.location.search);
            const fileName = urlParams.get("file");

            if (!fileName) {
                document.getElementById("nota-contenido").innerHTML = "<p>Error: No se especificó un archivo de nota.</p>";
                return;
            }

            try {
                const response = await fetch(`../content/notas/${fileName}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();
                console.log("Markdown cargado:", text);

                const { metadata, content } = extractMetadata(text);
                console.log("Metadata extraída:", metadata);

                const pageTitle = metadata.titulo || "Nota";
                document.getElementById("page-title").textContent = pageTitle;
                document.getElementById("nota-titulo").textContent = pageTitle;

                document.getElementById("nota-descripcion").innerHTML = metadata.descripcion ? metadata.descripcion.replace(/\n/g, "<br>") : "Sin descripción";
                document.getElementById("nota-publicado-por").textContent = metadata.publicado_por || "Desconocido";
                document.getElementById("nota-rol").textContent = metadata.rol || "Desconocido";
                document.getElementById("nota-fecha-publicacion").textContent = metadata.fecha_publicacion || "Desconocida";

                const converter = new showdown.Converter();
                document.getElementById("nota-concepto").innerHTML = metadata.concepto ? metadata.concepto.replace(/\n/g, "<br>") : "";
                document.getElementById("nota-contenido").innerHTML = converter.makeHtml(metadata.contenido);

                if (metadata.imagen) {
                    const img = document.getElementById("nota-imagen");
                    img.src = metadata.imagen.startsWith("/") ? `../static${metadata.imagen}` : `../static/images/${metadata.imagen}`;
                    img.style.display = "block";
                }

            } catch (error) {
                document.getElementById("nota-contenido").innerHTML = `<p>Error al cargar la nota: ${error.message}</p>`;
            }
        }

        loadMarkdown();
    </script>
</body>
</html>
