<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Nota</title>
</head>
<body>
    <header>
        <h1 id="nota-titulo">Nota</h1>
        <div id="nota-descripcion"></div>
    </header>
    
    <section id="nota-detalles">
        <p><strong>Publicado por:</strong> <span id="nota-publicado-por">Desconocido</span></p>
        <p><strong>Rol del autor:</strong> <span id="nota-rol">Desconocido</span></p>
        <p><strong>Fecha de publicación:</strong> <span id="nota-fecha-publicacion">Desconocida</span></p>
    </section>

    <section id="nota-contenido">
        <h2 id="nota-subtitulo-1"></h2>
        <p id="nota-parrafo-1"></p>
        <h2 id="nota-subtitulo-2"></h2>
        <p id="nota-parrafo-2"></p>
    </section>

    <section id="nota-imagen-container">
        <img id="nota-imagen" style="display:none;" alt="Imagen de la nota" />
    </section>

    <script>
        function extractMetadata(markdown) {
            const metadataRegex = /^---\n([\s\S]+?)\n---\n([\s\S]*)/;
            const match = markdown.match(metadataRegex);
            
            if (!match) return { metadata: {}, content: markdown };
            
            const metadataLines = match[1].split("\n");
            const metadata = {};
            metadataLines.forEach(line => {
                const [key, ...value] = line.split(": ");
                metadata[key.trim()] = value.join(": ").trim();
            });

            return { metadata, content: match[2] };
        }

        async function loadMarkdown() {
            const urlParams = new URLSearchParams(window.location.search);
            const fileName = urlParams.get("file");

            if (!fileName) {
                document.getElementById("nota-contenido").innerHTML = "<p>Error: No se especificó un archivo de nota.</p>";
                return;
            }

            try {
                const response = await fetch(`/content/notas/${fileName}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();

                const { metadata, content } = extractMetadata(text);
                console.log(metadata); // Verifica los metadatos extraídos

                document.getElementById("page-title").textContent = metadata.titulo || "Nota";
                document.getElementById("nota-titulo").textContent = metadata.titulo || "Nota";
                document.getElementById("nota-descripcion").innerHTML = metadata.descripcion ? metadata.descripcion.replace(/\n/g, "<br>") : "Sin descripción";
                document.getElementById("nota-publicado-por").textContent = metadata.publicado_por || "Desconocido";
                document.getElementById("nota-rol").textContent = metadata.rol || "Desconocido";
                document.getElementById("nota-fecha-publicacion").textContent = metadata.fecha_publicacion || "Desconocida";
                
                document.getElementById("nota-subtitulo-1").textContent = metadata.subtitulo_1 || "";
                document.getElementById("nota-parrafo-1").textContent = metadata.parrafo_1 || "";
                document.getElementById("nota-subtitulo-2").textContent = metadata.subtitulo_2 || "";
                document.getElementById("nota-parrafo-2").textContent = metadata.parrafo_2 || "";

                if (metadata.imagen) {
                    const img = document.getElementById("nota-imagen");
                    img.src = metadata.imagen.startsWith("/") ? `../static${metadata.imagen}` : `../static/images/${metadata.imagen}`;
                    img.style.display = "block";
                }

                // Si el contenido adicional está presente, mostrarlo también
                if (content) {
                    // Asegura que el contenido del archivo Markdown también sea mostrado
                    document.getElementById("nota-contenido").innerHTML += content.replace(/\n/g, "<br>");
                }

            } catch (error) {
                document.getElementById("nota-contenido").innerHTML = `<p>Error al cargar la nota: ${error.message}</p>`;
            }
        }

        loadMarkdown();
    </script>
</body>
</html>
