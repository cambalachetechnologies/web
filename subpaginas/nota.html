<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Nota</title>
    <link rel="stylesheet" href="../css/stylenota.css">
    <script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script> <!-- Agregada librería para parsear YAML -->
</head>
<body>
    <article class="nota">
        <header class="nota-header">
            <div class="nota-info">
                <h1 id="nota-titulo"></h1>
                <p id="nota-descripcion"></p>
            </div>
            <img id="nota-imagen" class="nota-imagen" style="display: none;"/>
        </header>

        <section class="nota-metadata">
            <p><strong>Publicado por:</strong> <span id="nota-publicado-por"></span></p>
            <p><strong>Rol:</strong> <span id="nota-rol"></span></p>
            <p><strong>Fecha de publicación:</strong> <span id="nota-fecha-publicacion"></span></p>
        </section>

        <section id="nota-concepto" class="nota-concepto"></section>
        <section id="nota-contenido" class="nota-contenido"></section>
    </article>

    <script>
        async function loadMarkdown() {
            const urlParams = new URLSearchParams(window.location.search);
            const fileName = urlParams.get("file");

            if (!fileName) {
                document.getElementById("nota-contenido").innerHTML = "<p>Error: No se especificó un archivo de nota.</p>";
                return;
            }

            try {
                const response = await fetch(`../content/notas/${fileName}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const text = await response.text();
                console.log("Markdown cargado:", text);

                const { metadata, content } = extractMetadata(text);
                console.log("Metadata extraída:", metadata);

                // Asegúrate de que no estamos reasignando variables constantes
                const pageTitle = metadata.titulo || "Nota";
                document.getElementById("page-title").textContent = pageTitle;
                document.getElementById("nota-titulo").textContent = pageTitle;

                document.getElementById("nota-descripcion").innerHTML = metadata.descripcion ? metadata.descripcion.replace(/\n/g, "<br>") : "Sin descripción";
                document.getElementById("nota-publicado-por").textContent = metadata.publicado_por || "Desconocido";
                document.getElementById("nota-rol").textContent = metadata.rol || "Desconocido";
                document.getElementById("nota-fecha-publicacion").textContent = metadata.fecha_publicacion || "Desconocida";
                document.getElementById("nota-concepto").innerHTML = metadata.concepto ? metadata.concepto.replace(/\n/g, "<br>") : "";

                if (metadata.imagen) {
                    const img = document.getElementById("nota-imagen");
                    img.src = metadata.imagen.startsWith("/") ? `../static${metadata.imagen}` : `../static/images/${metadata.imagen}`;
                    img.style.display = "block";
                }

                const converter = new showdown.Converter();
                generateSections(metadata.secciones || [], converter);
            } catch (error) {
                document.getElementById("nota-contenido").innerHTML = `<p>Error al cargar la nota: ${error.message}</p>`;
            }
        }

        function extractMetadata(text) {
            let metadata = {};  // Cambié a 'let' para evitar la reasignación de una constante
            let content = "";
            const match = text.match(/---([\s\S]*?)---\s*\n([\s\S]*)/);

            if (match) {
                const metadataText = match[1].trim();
                content = match[2].trim();

                metadata = jsyaml.load(metadataText); // Parseamos el YAML correctamente

                if (metadata.secciones) {
                    try {
                        metadata.secciones = JSON.parse(metadata.secciones);
                    } catch (error) {
                        console.error("Error parseando secciones JSON:", error);
                        metadata.secciones = [];
                    }
                }
            } else {
                content = text.trim();
            }

            return { metadata, content };
        }

        function generateSections(secciones, converter) {
            if (!Array.isArray(secciones) || secciones.length === 0) {
                console.warn("⚠ No hay secciones definidas.");
                return;
            }

            const contenidoDiv = document.getElementById("nota-contenido");
            contenidoDiv.innerHTML = "";

            secciones.forEach(seccion => {
                const seccionDiv = document.createElement("div");
                seccionDiv.classList.add("nota-seccion");

                if (seccion.subtitulo) {
                    const subtitulo = document.createElement("h2");
                    subtitulo.textContent = seccion.subtitulo;
                    seccionDiv.appendChild(subtitulo);
                }

                if (seccion.parrafo) {
                    const parrafo = document.createElement("p");
                    parrafo.innerHTML = converter.makeHtml(seccion.parrafo);
                    seccionDiv.appendChild(parrafo);
                }

                if (seccion.imagen) {
                    const img = document.createElement("img");
                    img.src = seccion.imagen.startsWith("/") ? `../static${seccion.imagen}` : `../static/images/${seccion.imagen}`;
                    img.classList.add("nota-imagen-secundaria");
                    seccionDiv.appendChild(img);
                }

                contenidoDiv.appendChild(seccionDiv);
            });
        }

        loadMarkdown();
    </script>
</body>
</html>
